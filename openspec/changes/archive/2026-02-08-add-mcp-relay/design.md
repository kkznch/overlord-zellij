## 背景

overlord-zellij は Zellij ターミナルマルチプレクサで6つの Claude Code インスタンスを起動するプロジェクト（魔王、軍師、四天王）。現在これらのインスタンスには自動通信チャネルがなく、ユーザーがペイン間で手動コピペする必要がある。本設計では MCP ベースの relay システムを導入し、完全自動のエージェント間メッセージングを実現する。

## 目標 / 非目標

**目標:**
- 任意の Claude インスタンスが MCP ツール経由で他のインスタンスにメッセージを送信できる
- Zellij ペインにテキストを注入してメッセージ処理を自動トリガーする
- 複数メッセージ同時到着時の重複トリガーを防止する
- トークン効率を維持する（短いトリガーテキスト、コード全文ではなくファイルパス参照）
- 全 Claude インスタンスをインタラクティブモードで維持（Zellij ペインで可視）

**非目標:**
- リアルタイムストリーミングや WebSocket ベースの通信
- コードでのトポロジー強制（トポロジーは儀式ファイルで定義、relay ロジックではない）
- 役割間のメッセージ順序保証
- relay メッセージの暗号化や認証

## 設計判断

### D1: ファイルベースメッセージストア（インメモリやDBではなく）
**選択:** `~/.config/ovld/relay/` 配下の JSON メッセージファイルによるファイルベースストア。
**理由:** 6つの独立した MCP サーバープロセスが共有状態を必要とする。ファイルベースなら外部デーモン不要、DB不要、単純なアトミックファイル操作で動作。メッセージ量は少ない（セッションあたり数十件、数千件ではない）。
**検討した代替案:**
- SQLite: 少量メッセージングには不要な複雑さ
- 共有メモリ / IPC: 常駐デーモンプロセスが必要
- TCP ソケット: 6ピアの接続管理が複雑

### D2: 役割ごとの MCP サーバー (stdio)
**選択:** 各 Claude インスタンスが `--mcp-config` で自身の `ovld relay` サブプロセスに接続、stdio トランスポート使用。
**理由:** Claude Code は MCP サーバー設定をネイティブサポート。各サーバーは環境変数 (`OVLD_ROLE`、`OVLD_RELAY_DIR`、`OVLD_SESSION`) で自身を識別。stdio トランスポートが最もシンプルでポート管理不要。
**検討した代替案:**
- 単一共有 MCP サーバー: マルチプレキシングと共有トランスポートでの役割識別が必要
- SSE/HTTP トランスポート: 不要な複雑さ。Claude Code が stdio サブプロセスのライフサイクルを自動管理

### D3: Zellij write-chars + write による自動トリガー
**選択:** メッセージ保存後、送信者の MCP サーバーが `zellij action write-chars` で受信者ペインにトリガーテキストを注入、続けて `zellij action write-chars "\r"` で Enter キー送信。
**理由:** 受信側の Claude がトリガーテキストをユーザー入力として認識し、自動処理する。ポーリング不要、最小トークンコストで即時通知。
**検討した代替案:**
- タイマーポーリング: 空チェックでトークン浪費、即時応答なし
- Zellij プラグイン: WASM プラグインの開発が必要で高複雑度

### D4: 重複排除用 pending フラグ
**選択:** ファイルベースの pending フラグ (`pending/{role}`)。最初の通知送信時にセットし、`check_inbox` 呼び出し時にクリア。
**理由:** 処理前に複数メッセージが到着した場合、最初のみが `write-chars` をトリガー。これなしでは Claude インスタンスが同一トリガー行を複数受信し、トークン浪費。

### D5: MCP 実装に rmcp 0.14 クレート
**選択:** `rmcp` Rust クレート (v0.14) の `#[tool_router]` / `#[tool_handler]` マクロを使用。
**理由:** tokio と統合するネイティブ Rust MCP SDK。stdio トランスポートと `schemars` による JSON Schema 導出をサポート。

## リスク / トレードオフ

- **[ファイルシステム競合]** → 複数 MCP サーバーが同時読み書きする可能性。緩和策: 役割ごとの独立 inbox ディレクトリ、pending フラグのアトミック作成、稀な重複読み取りの許容。
- **[Zellij write-chars の脆弱性]** → 通知機構がフォーカスされたペインへの Zellij アクションコマンドの正常動作に依存。フォーカス追跡が誤ると、メッセージが間違ったペインに送られる。緩和策: 注入前の明示的タブ切り替えと方向フォーカス。
- **[Enter キーの配信]** → ターミナルエミュレータや TUI フレームワークによって CR/LF の扱いが異なる可能性。`write-chars "\r"` (CR) アプローチが普遍的に動作しない場合がある。フォールバック戦略が必要かもしれない。
- **[Claude Code バージョン依存]** → インストール済み Claude Code が `--mcp-config` フラグをサポートしている必要がある。未サポート時のグレースフルデグラデーションなし。
